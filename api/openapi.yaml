openapi: 3.0.3
info:
  title: Snack Store API
  version: 1.0.0
  description: REST API for snack store transactions, redemptions, and reports.
servers:
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Common
    description: Health and welcome endpoints
  - name: Products
  - name: Customers
  - name: Transactions
  - name: Redemptions
  - name: Reports

paths:
  /:
    get:
      tags:
        - Common
      summary: Welcome
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseWelcome"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /api:
    get:
      tags:
        - Common
      summary: Welcome (API)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseWelcome"
        "429":
          $ref: "#/components/responses/TooManyRequests"
  /health:
    get:
      tags:
        - Common
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseHealth"
        "429":
          $ref: "#/components/responses/TooManyRequests"

  /api/products:
    post:
      tags:
        - Products
      summary: Create product
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateProductRequest"
            examples:
              example:
                value:
                  name: Keripik Pangsit
                  type: Keripik Pangsit
                  flavor: Jagung Bakar
                  size: Small
                  price: 10000
                  stock_qty: 50
                  manufactured_date: "2025-10-01"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseProduct"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"
    get:
      tags:
        - Products
      summary: List products by manufactured date
      parameters:
        - name: date
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseProductList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/customers:
    get:
      tags:
        - Customers
      summary: List customers
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: page_size
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 10
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseCustomerList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/transactions:
    post:
      tags:
        - Transactions
      summary: Create transaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTransactionRequest"
            examples:
              example:
                value:
                  customer_name: Fery
                  product_id: 11111111-1111-1111-1111-111111111111
                  qty: 2
                  transaction_at: "2025-10-22T15:00:22Z"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseTransaction"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"
    get:
      tags:
        - Transactions
      summary: List transactions by date range
      parameters:
        - name: start
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: end
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: page_size
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 10
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseTransactionList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/redemptions:
    post:
      tags:
        - Redemptions
      summary: Create redemption
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateRedemptionRequest"
            examples:
              example:
                value:
                  customer_name: Fery
                  product_id: 11111111-1111-1111-1111-111111111111
                  qty: 1
                  redeem_at: "2025-12-01T10:00:00Z"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseRedemption"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/reports/transactions:
    get:
      tags:
        - Reports
      summary: Report transactions by date range
      parameters:
        - name: start
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: end
          in: query
          required: true
          schema:
            type: string
            format: date
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebResponseReportTransactions"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  schemas:
    ErrorDetail:
      type: object
      properties:
        code:
          type: string
          example: VALIDATION_ERROR
        message:
          type: string
          example: validation error occurred
    ErrorResponse:
      type: object
      properties:
        error:
          $ref: "#/components/schemas/ErrorDetail"

    PageMetadata:
      type: object
      properties:
        current_page:
          type: integer
        page_size:
          type: integer
        total_item:
          type: integer
          format: int64
        total_page:
          type: integer
          format: int64
        has_next:
          type: boolean
        has_previous:
          type: boolean

    WelcomeData:
      type: object
      properties:
        status:
          type: string
          example: ok
    WebResponseWelcome:
      type: object
      properties:
        message:
          type: string
          example: Welcome to Snack Store API!
        data:
          $ref: "#/components/schemas/WelcomeData"

    HealthData:
      type: object
      properties:
        status:
          type: string
          example: ok
    WebResponseHealth:
      type: object
      properties:
        message:
          type: string
          example: Health check success
        data:
          $ref: "#/components/schemas/HealthData"

    CreateProductRequest:
      type: object
      required: [name, type, flavor, size, price, stock_qty, manufactured_date]
      properties:
        name:
          type: string
        type:
          type: string
        flavor:
          type: string
        size:
          type: string
          enum: [Small, Medium, Large]
        price:
          type: integer
        stock_qty:
          type: integer
        manufactured_date:
          type: string
          format: date

    ProductResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        type:
          type: string
        flavor:
          type: string
        size:
          type: string
          enum: [Small, Medium, Large]
        price:
          type: integer
        stock_qty:
          type: integer
        manufactured_date:
          type: string
          format: date

    WebResponseProduct:
      type: object
      properties:
        message:
          type: string
          example: Product created successfully
        data:
          $ref: "#/components/schemas/ProductResponse"

    WebResponseProductList:
      type: object
      properties:
        message:
          type: string
          example: Products fetched successfully
        data:
          type: array
          items:
            $ref: "#/components/schemas/ProductResponse"

    CustomerResponse:
      type: object
      properties:
        name:
          type: string
        points:
          type: integer

    WebResponseCustomerList:
      type: object
      properties:
        message:
          type: string
          example: Customers fetched successfully
        data:
          type: array
          items:
            $ref: "#/components/schemas/CustomerResponse"
        paging:
          $ref: "#/components/schemas/PageMetadata"

    CreateTransactionRequest:
      type: object
      required: [customer_name, product_id, qty, transaction_at]
      properties:
        customer_name:
          type: string
        product_id:
          type: string
          format: uuid
        qty:
          type: integer
          minimum: 1
        transaction_at:
          type: string
          format: date-time

    TransactionResponse:
      type: object
      properties:
        transaction_id:
          type: string
          format: uuid
        customer_name:
          type: string
        product_name:
          type: string
        size:
          type: string
        flavor:
          type: string
        qty:
          type: integer
        unit_price:
          type: integer
        total_price:
          type: integer
        points_earned:
          type: integer
        transaction_at:
          type: string
          format: date-time

    WebResponseTransaction:
      type: object
      properties:
        message:
          type: string
          example: Transaction created successfully
        data:
          $ref: "#/components/schemas/TransactionResponse"

    WebResponseTransactionList:
      type: object
      properties:
        message:
          type: string
          example: Transactions fetched successfully
        data:
          type: array
          items:
            $ref: "#/components/schemas/TransactionResponse"
        paging:
          $ref: "#/components/schemas/PageMetadata"

    CreateRedemptionRequest:
      type: object
      required: [customer_name, product_id, qty, redeem_at]
      properties:
        customer_name:
          type: string
        product_id:
          type: string
          format: uuid
        qty:
          type: integer
          minimum: 1
        redeem_at:
          type: string
          format: date-time

    RedemptionResponse:
      type: object
      properties:
        redemption_id:
          type: string
          format: uuid
        customer_name:
          type: string
        product_name:
          type: string
        size:
          type: string
        qty:
          type: integer
        points_spent:
          type: integer
        redeem_at:
          type: string
          format: date-time

    WebResponseRedemption:
      type: object
      properties:
        message:
          type: string
          example: Redemption created successfully
        data:
          $ref: "#/components/schemas/RedemptionResponse"

    ReportBestSeller:
      type: object
      properties:
        product_name:
          type: string
        size:
          type: string
        flavor:
          type: string
        total_qty:
          type: integer

    ReportTransactionItem:
      type: object
      properties:
        transaction_id:
          type: string
          format: uuid
        customer_name:
          type: string
        product_name:
          type: string
        size:
          type: string
        flavor:
          type: string
        qty:
          type: integer
        unit_price:
          type: integer
        total_price:
          type: integer
        points_earned:
          type: integer
        transaction_at:
          type: string
          format: date-time
        is_new_customer:
          type: boolean

    ReportTransactionsResponse:
      type: object
      properties:
        total_customer:
          type: integer
          format: int64
        has_new_customer:
          type: boolean
        total_income:
          type: integer
        best_seller:
          $ref: "#/components/schemas/ReportBestSeller"
        total_products_sold:
          type: integer
        last_transactions:
          type: array
          items:
            $ref: "#/components/schemas/ReportTransactionItem"

    WebResponseReportTransactions:
      type: object
      properties:
        message:
          type: string
          example: Report fetched successfully
        data:
          $ref: "#/components/schemas/ReportTransactionsResponse"

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: VALIDATION_ERROR
              message: Invalid input format
    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: NOT_FOUND
              message: Resource not found
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: CONFLICT
              message: Insufficient stock
    TooManyRequests:
      description: Too Many Requests
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: TOO_MANY_REQUESTS
              message: Too many requests, please try again later
    InternalServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: INTERNAL_SERVER_ERROR
              message: Internal server error
